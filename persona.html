// Wait for the document to load
document.addEventListener('DOMContentLoaded', function () {
    const generateButton = document.getElementById('generateButton');
    const roleSelection = document.getElementById('roleSelection');
    const interviewInstructions = document.getElementById('interviewInstructions');
    const resumeUpload = document.getElementById('resumeUpload');
    const jobDescriptionLink = document.getElementById('jobDescriptionLink');
    const personaSection = document.getElementById('generatedPersona');
    const personaRole = document.getElementById('personaRole');
    const personaTone = document.getElementById('personaTone');
    const personaResume = document.getElementById('personaResume');
    const personaJobDescription = document.getElementById('personaJobDescription');
    const transcriptContent = document.getElementById('transcriptContent');
    const liveTranscriptControls = document.getElementById('liveTranscriptControls');

    let fullTranscript = "";

    // Generate persona button click handler
    generateButton.addEventListener('click', function () {
        // Display persona based on selections
        personaRole.textContent = `Role: ${roleSelection.value}`;
        personaTone.textContent = `Tone: ${getSelectedTone()}`;
        personaResume.textContent = `Resume: ${resumeUpload.files[0] ? resumeUpload.files[0].name : 'No resume uploaded'}`;
        personaJobDescription.textContent = `Job Description: ${jobDescriptionLink.value}`;

        personaSection.classList.remove('hidden');
        liveTranscriptControls.classList.remove('hidden');
    });

    // Function to get selected tones
    function getSelectedTone() {
        let selectedTones = [];
        const toneCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        toneCheckboxes.forEach(function (checkbox) {
            selectedTones.push(checkbox.value);
        });
        return selectedTones.join(', ') || 'No tone selected';
    }

    // Initialize Speech Recognition API for live listening
    let recognition;
    function startListening() {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = function (event) {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    fullTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            transcriptContent.innerText = fullTranscript + interimTranscript;
        };

        recognition.start();
    }

    // Stop listening handler
    document.getElementById('stopListening').addEventListener('click', function () {
        if (recognition) {
            recognition.stop();
            alert("Listening stopped.");
        }
    });

    // End meeting handler
    document.getElementById('endMeeting').addEventListener('click', function () {
        if (recognition) {
            recognition.stop();
        }
        generateMeetingSummary();
    });

    // Download transcript handler
    document.getElementById('downloadTranscript').addEventListener('click', function () {
        const blob = new Blob([fullTranscript], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Interview_Transcript.txt';
        a.click();
        URL.revokeObjectURL(url);
    });

    // Generate meeting summary
    function generateMeetingSummary() {
        const sentences = fullTranscript.split('.').filter(Boolean);
        const topics = sentences.slice(
